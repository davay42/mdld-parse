<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MD-LD - Markdown Linked Data Parser</title>
    <meta name="description"
        content="MD-LD v0.3: Human-friendly RDF authoring format. Write semantic data in natural Markdown. Parse to RDF triples. Zero dependencies.">
    <style>
        :root {
            --bg-light: #f8f9fa;
            --text-dark: #374151;
            --accent-orange: #af540f;
            --accent-orange-light: #d9711f;
            --border-dark: #374151;
            --bg-code: #e2e2e2;
            --text-code: #1d1d1d;
            --text-muted: #525253;
            --bg-feature: rgb(255, 254, 248);
            --text-feature: #181818;
            --bg-hover: rgb(227, 222, 218);
            --border-focus: #60a5fa;
            --bg-button-primary: #6a9962;
            --bg-button-primary-hover: #2563eb;
            --bg-button-secondary: #4b5563;
            --bg-button-secondary-hover: #6b7280;
            --bg-button-danger: #ef4444;
            --bg-button-danger-hover: #dc2626;
            --bg-input: #d2d2d2;
            --border-chip-default: #334155;
            --bg-chip-default: #7e7e7f;
            --text-chip-key: #94a3b8;
            --border-chip-subject: #1e3a8a;
            --bg-chip-subject: #dbd9d9;
            --text-chip-subject: #0c4587;
            --border-chip-predicate: #334155;
            --bg-chip-predicate: #cfd1d5;
            --text-chip-predicate: #313335;
            --border-chip-object: #3f3f46;
            --bg-chip-object: #b8cfc0;
            --text-chip-object: #0d361e;
            --border-chip-literal: #44403c;
            --bg-chip-literal: #b4c1b3;
            --text-chip-literal: #bfc6be;
            --text-separator: #64748b;
            --color-success: #10b981;
            --color-error: #ef4444;
            --color-info: #60a5fa;
            --text-pill: #cbd5e1;
            --bg-table-header: #111827;
            --text-table-header: #cbd5e1;
            --font-mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', monospace;
            line-height: 1.5;
            color: var(--text-dark);
            background: var(--bg-light);
        }

        code {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace
        }

        .container {
            max-width: 65ch;
            margin: 0 auto;
            padding: 1rem
        }

        .hidden {
            display: none
        }

        .link-hover:hover {
            background: var(--bg-hover);
            border-color: var(--accent-orange);
        }

        .example-hover:hover {
            border-color: var(--border-focus);
        }

        .btn-hover:hover {
            transform: translateY(-1px);
        }

        @media (max-width: 900px) {
            .playground {
                grid-template-columns: 1fr !important
            }
        }

        @media (max-width: 768px) {
            .stats {
                grid-template-columns: repeat(2, 1fr) !important
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header
            style="text-align: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-dark);">
            <div style="font-size: 4em;">
                <span style="opacity:50%">{</span><span style="color: var(--accent-orange)">=+ .?!</span><span
                    style="opacity:50%">}</span>
            </div>
            <h1
                style="font-size: 2.5rem; font-weight: 700; margin-bottom: .5rem; background: linear-gradient(135deg, var(--accent-orange-light), var(--accent-orange)); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                MD-LD</h1>
            <h2 style="font-size: 1.5rem; font-weight: 500; margin-bottom: .5rem; color: var(--text-dark);">Markdown
                Linked Data</h2>
            <p style="font-size: 1.2rem; color: var(--accent-orange); margin-bottom: 1rem;">Human-friendly knowledge
                graph authoring</p>
            <div style="display: flex; gap: .5rem; justify-content: center; flex-wrap: wrap; margin-bottom: 1rem;">
                <a href="https://github.com/davay42/mdld-parse" target="_blank" class="link-hover"
                    style="color: var(--accent-orange); text-decoration: none; padding: .25rem .75rem; border: 1px solid var(--border-dark); border-radius: 4px; font-size: .875rem; transition: all .2s;">üì¶
                    GitHub</a>
                <a href="https://www.npmjs.com/package/mdld-parse" target="_blank" class="link-hover"
                    style="color: var(--accent-orange); text-decoration: none; padding: .25rem .75rem; border: 1px solid var(--border-dark); border-radius: 4px; font-size: .875rem; transition: all .2s;">üì¶
                    npm</a>
            </div>
        </header>

        <section id="format"
            style="background: var(--bg-code); border-radius: 6px; padding: 1rem; margin-bottom: 1rem;">
            <h3 style="margin-bottom: .5rem; color: var(--text-feature); font-size: 1rem;">üìñ What is MD-LD?</h3>
            <p style="color: var(--text-muted); font-size: .875rem; margin-bottom: .5rem;">MD-LD extends Markdown with
                semantic annotations using <code>{...}</code> blocks. Write natural language
                documents while embedding structured RDF data.</p>

            <div style="display: flex; flex-wrap: wrap; gap: .5rem;">
                <div style="background: var(--bg-feature); border-radius: 0.5em; padding: .5rem; flex: 1">
                    <h4 style="margin-bottom: .25rem; color: var(--text-feature); font-size: .875rem;">üìù Natural Syntax
                    </h4>
                    <p style="color: var(--text-muted); font-size: .75rem;">Write semantic data in familiar Markdown</p>
                </div>
                <div style="background: var(--bg-feature); border-radius: 0.5em; padding: .5rem; flex: 1">
                    <h4 style="margin-bottom: .25rem; color: var(--text-feature); font-size: .875rem;">üîó RDF Output
                    </h4>
                    <p style="color: var(--text-muted); font-size: .75rem;">Parse to standard RDF triples</p>
                </div>
                <div style="background: var(--bg-feature);  border-radius: .5em; padding: .5rem; flex: 1;">
                    <h4 style="margin-bottom: .25rem; color: var(--text-feature); font-size: .875rem;">‚ö° Zero
                        Dependencies</h4>
                    <p style="color: var(--text-muted); font-size: .75rem;">Lightweight parser</p>
                </div>
                <div style="background: var(--bg-feature); border-radius: .5em; padding: .5rem; flex: 1;">
                    <h4 style="margin-bottom: .25rem; color: var(--text-feature); font-size: .875rem;">üîÑ Bidirectional
                    </h4>
                    <p style="color: var(--text-muted); font-size: .75rem;">Parse & serialize round-trip</p>
                </div>
            </div>
        </section>

        <section id="playground"
            style="background: var(--bg-code); border-radius: 6px; padding: 1rem; margin-bottom: 1rem;">
            <h3 style="margin-bottom: .5rem; color: var(--text-feature); font-size: 1rem;">üéÆ Interactive Playground
            </h3>

            <div
                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: .5rem; margin-bottom: 1rem;">
                <div onclick="loadExample('minimal')" class="example-hover"
                    style="background: var(--bg-code); border: 1px solid var(--border-dark); border-radius: 4px; padding: .75rem; cursor: pointer; transition: all .2s;">
                    <h4 style="margin-bottom: .25rem; color: var(--text-feature); font-size: .875rem;">üçå Minimal viable
                    </h4>
                    <p style="font-size: .75rem; color: var(--text-muted);">Smallest example of knowledge authoring</p>
                </div>
                <div onclick="loadExample('journal')" class="example-hover"
                    style="background: var(--bg-code); border: 1px solid var(--border-dark); border-radius: 4px; padding: .75rem; cursor: pointer; transition: all .2s;">
                    <h4 style="margin-bottom: .25rem; color: var(--text-feature); font-size: .875rem;">üìî Personal
                        Journal</h4>
                    <p style="font-size: .75rem; color: var(--text-muted);">Mood, location, people</p>
                </div>
                <div onclick="loadExample('recipe')" class="example-hover"
                    style="background: var(--bg-code); border: 1px solid var(--border-dark); border-radius: 4px; padding: .75rem; cursor: pointer; transition: all .2s;">
                    <h4 style="margin-bottom: .25rem; color: var(--text-feature); font-size: .875rem;">üç≥ Recipe</h4>
                    <p style="font-size: .75rem; color: var(--text-muted);">Ingredients & instructions</p>
                </div>
                <div onclick="loadExample('project')" class="example-hover"
                    style="background: var(--bg-code); border: 1px solid var(--border-dark); border-radius: 4px; padding: .75rem; cursor: pointer; transition: all .2s;">
                    <h4 style="margin-bottom: .25rem; color: var(--text-feature); font-size: .875rem;">üìã Project</h4>
                    <p style="font-size: .75rem; color: var(--text-muted);">Tasks & relationships</p>
                </div>
                <div onclick="loadExample('apollo')" class="example-hover"
                    style="background: var(--bg-code); border: 1px solid var(--border-dark); border-radius: 4px; padding: .75rem; cursor: pointer; transition: all .2s;">
                    <h4 style="margin-bottom: .25rem; color: var(--text-feature); font-size: .875rem;">üöÄ Apollo Mission
                    </h4>
                    <p style="font-size: .75rem; color: var(--text-muted);">Complex structure</p>
                </div>
            </div>
            <div
                style="display: flex; flex-flow: wrap; grid-template-columns: minmax(360px, 1.2fr) minmax(360px, 1fr) minmax(360px, 1fr); gap: 1rem; margin-bottom: 1rem; align-items: start;">
                <div style="min-width: 100%;">
                    <h3 style="margin-bottom: .5rem; color: var(--text-feature); font-size: 1rem;">MD-LD Input</h3>
                    <textarea id="input"
                        style="width: 100%; height: 250px; padding: .75rem; border: 1px solid var(--border-dark); border-radius: 4px; font-family: var(--font-mono); font-size: 13px; resize: vertical; background: var(--bg-light); color: var(--text-code);"
                        placeholder="Write your MD-LD here...

Example:
## Document {=ex:doc}
Title: [My Document] {name}
Author: [Alice] {+ex:alice .Person ?author name}"></textarea>
                </div>
                <div style="min-width: 0;">
                    <h3 style="margin-bottom: .5rem; color: var(--text-feature); font-size: 1rem;">Quads (highlighted)
                    </h3>
                    <div id="output"
                        style="background: var(--bg-light); border: 1px solid var(--border-dark); border-radius: 4px; padding: .75rem; height: 250px; font-family: var(--font-mono); font-size: 13px; white-space: pre-wrap; overflow: auto; color: var(--text-code);">
                        Quads will appear here...</div>
                </div>
                <!-- <div style="min-width: 0;">
                    <h3 style="margin-bottom: .5rem; color: var(--text-feature); font-size: 1rem;">Rendered HTML+RDFa
                    </h3>
                    <div id="rendered-output"
                        style="background: var(--bg-code); border: 1px solid var(--border-dark); border-radius: 4px; padding: .75rem; height: 250px; font-family: var(--font-mono); font-size: 13px; overflow: auto; color: var(--text-code);">
                        Rendered HTML will appear here...</div> -->
            </div>
    </div>
    <div class="container" style="display: flex; gap: .5rem; margin-bottom: 1rem; align-items: center;">
        <button onclick="parseMDLD()" class="btn-hover"
            style="background: var(--bg-button-primary); color: #fff; border: none; padding: .5rem 1rem; border-radius: 4px; cursor: pointer; font-weight: 500; font-size: .875rem;">üîÑ
            Parse
            MD-LD</button>
        <button onclick="clearPlayground()" class="btn-hover"
            style="background: var(--bg-button-secondary); color: #fff; border: none; padding: .5rem 1rem; border-radius: 4px; cursor: pointer; font-weight: 500; font-size: .875rem;">üóëÔ∏è
            Clear</button>
        <button onclick="toggleQuadLab()" class="btn-hover"
            style="background: var(--bg-button-secondary); color: #fff; border: none; padding: .5rem 1rem; border-radius: 4px; cursor: pointer; font-weight: 500; font-size: .875rem;">üß©
            Quad
            Lab</button>
        <span id="parse-stats"
            style="display: flex; gap: 1rem; font-size: .875rem; color: var(--text-muted); margin-left: auto;"></span>
    </div>

    <div style="margin-top: .75rem;" class="hidden container" id="quadlab">
        <h3 style="margin-bottom: .5rem; color: var(--text-feature); font-size: 1rem;">üß© Quad Lab (CRUD + diff
            apply)</h3>
        <p style="color: var(--text-muted); margin-bottom: .5rem;">Edit quads below. Applying changes generates
            a diff and calls <code>serialize()</code>
            to patch the MD-LD source.</p>
        <div style="display: flex; gap: .5rem; margin-bottom: .5rem; align-items: center;">
            <button onclick="quadLabReset()" class="btn-hover"
                style="background: var(--bg-button-secondary); color: #fff; border: none; padding: .5rem 1rem; border-radius: 4px; cursor: pointer; font-weight: 500; font-size: .875rem;">‚Ü©
                Reset
                from parse()</button>
            <button onclick="quadLabAddRow()" class="btn-hover"
                style="background: var(--bg-button-primary); color: #fff; border: none; padding: .5rem 1rem; border-radius: 4px; cursor: pointer; font-weight: 500; font-size: .875rem;">‚ûï
                Add quad</button>
            <button onclick="quadLabDeleteSelected()" class="btn-hover"
                style="background: var(--bg-button-danger); color: #fff; border: none; padding: .5rem 1rem; border-radius: 4px; cursor: pointer; font-weight: 500; font-size: .875rem;">üóë
                Delete selected</button>
            <span id="quadlab-stats"
                style="display: flex; gap: 1rem; font-size: .875rem; color: var(--text-muted); margin-left: auto;"></span>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div>
                <table
                    style="width: 100%; border-collapse: collapse; border: 1px solid var(--border-dark); border-radius: 4px; overflow: hidden;">
                    <thead>
                        <tr>
                            <th
                                style="width: 2.5rem; background: var(--bg-table-header); color: var(--text-table-header); font-weight: 600; border-bottom: 1px solid var(--border-dark); padding: .35rem .5rem; text-align: left; font-size: .8rem;">
                                Sel</th>
                            <th
                                style="background: var(--bg-table-header); color: var(--text-table-header); font-weight: 600; border-bottom: 1px solid var(--border-dark); padding: .35rem .5rem; text-align: left; font-size: .8rem;">
                                S</th>
                            <th
                                style="background: var(--bg-table-header); color: var(--text-table-header); font-weight: 600; border-bottom: 1px solid var(--border-dark); padding: .35rem .5rem; text-align: left; font-size: .8rem;">
                                P</th>
                            <th
                                style="background: var(--bg-table-header); color: var(--text-table-header); font-weight: 600; border-bottom: 1px solid var(--border-dark); padding: .35rem .5rem; text-align: left; font-size: .8rem;">
                                O</th>
                        </tr>
                    </thead>
                    <tbody id="quadlab-body"></tbody>
                </table>
            </div>
            <div>
                <div id="quadlab-diff"
                    style="background: var(--bg-code); border: 1px solid var(--border-dark); border-radius: 4px; padding: .75rem; height: 250px; font-family: var(--font-mono); font-size: 13px; white-space: pre-wrap; overflow: auto; color: var(--text-code);">
                    Diff will appear here...</div>
                <div style="display: flex; gap: .5rem; margin-top: .5rem; margin-bottom: 0;">
                    <button onclick="quadLabApplyDiff()" class="btn-hover btn-hover-primary"
                        style="background: var(--bg-button-primary); color: #fff; border: none; padding: .5rem 1rem; border-radius: 4px; cursor: pointer; font-weight: 500; font-size: .875rem;">‚úÖ
                        Apply diff via
                        serialize()</button>
                    <button onclick="quadLabCopyDiff()" class="btn-hover btn-hover-secondary"
                        style="background: var(--bg-button-secondary); color: #fff; border: none; padding: .5rem 1rem; border-radius: 4px; cursor: pointer; font-weight: 500; font-size: .875rem;">üìã
                        Copy diff
                        JSON</button>
                </div>
            </div>
        </div>
    </div>
    </section>

    <section class="container" id="tests"
        style="background: var(--bg-code); border-radius: 6px; padding: 1rem; margin-bottom: 1rem;">
        <h3 style="margin-bottom: .5rem; color: var(--text-feature); font-size: 1rem;">üß™ Test Suite</h3>
        <div style="display: flex; gap: .5rem; margin-bottom: .5rem; align-items: center;">
            <button onclick="runAllTests()" class="btn-hover btn-hover-primary"
                style="background: var(--bg-button-primary); color: #fff; border: none; padding: .5rem 1rem; border-radius: 4px; cursor: pointer; font-weight: 500; font-size: .875rem; transition: all .2s;">‚ñ∂
                Run Tests</button>
            <button onclick="clearTests()" class="btn-hover btn-hover-secondary"
                style="background: var(--bg-button-secondary); color: #fff; border: none; padding: .5rem 1rem; border-radius: 4px; cursor: pointer; font-weight: 500; font-size: .875rem; transition: all .2s;">üóëÔ∏è
                Clear</button>
            <span id="test-status"
                style="display: flex; gap: 1rem; font-size: .875rem; color: var(--text-muted); margin-left: auto;"></span>
        </div>
        <div id="test-progress"
            style="height: 3px; background: var(--border-dark); border-radius: 2px; overflow: hidden; margin-bottom: .5rem; display: none;">
            <div id="test-progress-bar"
                style="height: 100%; background: var(--bg-button-primary); transition: width .3s ease;"></div>
        </div>
        <div id="test-stats"
            style="display: grid; grid-template-columns: repeat(4, 1fr); gap: .5rem; margin-bottom: .5rem; display: none;">
            <div
                style="background: var(--bg-feature); padding: .5rem; border-radius: 4px; text-align: center; border: 1px solid var(--border-dark);">
                <div id="passed-count"
                    style="font-size: 1.25rem; font-weight: 700; margin-bottom: .25rem; color: var(--color-success);">
                    0</div>
                <div style="font-size: .75rem; color: var(--text-muted);">Passed</div>
            </div>
            <div
                style="background: var(--bg-feature); padding: .5rem; border-radius: 4px; text-align: center; border: 1px solid var(--border-dark);">
                <div id="failed-count"
                    style="font-size: 1.25rem; font-weight: 700; margin-bottom: .25rem; color: var(--color-error);">
                    0</div>
                <div style="font-size: .75rem; color: var(--text-muted);">Failed</div>
            </div>
            <div
                style="background: var(--bg-feature); padding: .5rem; border-radius: 4px; text-align: center; border: 1px solid var(--border-dark);">
                <div id="total-count"
                    style="font-size: 1.25rem; font-weight: 700; margin-bottom: .25rem; color: var(--color-info);">0
                </div>
                <div style="font-size: .75rem; color: var(--text-muted);">Total</div>
            </div>
            <div
                style="background: var(--bg-feature); padding: .5rem; border-radius: 4px; text-align: center; border: 1px solid var(--border-dark);">
                <div id="duration" style="font-size: 1.25rem; font-weight: 700; margin-bottom: .25rem;">0ms</div>
                <div style="font-size: .75rem; color: var(--text-muted);">Duration</div>
            </div>
        </div>
        <div id="test-list" style="max-height: 300px; overflow-y: auto;">
            <p style="text-align: center; color: var(--text-muted); padding: 1rem;">Tests will run automatically on
                page
                load...</p>
        </div>
    </section>
    </div>

    <script type="importmap">
  {
    "imports": {
      "./index.js": "./index.js",
      "./tests.js": "./tests.js"
    }
  }
  </script>

    <script type="module">
        import { parse, serialize, shortenIRI } from './index.js';
        // import { render } from './render.js';
        import { runTests, tests } from './tests.js';

        let currentTestResults = [];

        // Example templates
        const examples = {
            minimal: `
## Document {=urn:mdld:doc}
Title: [My Document] {name}
Author: [Alice] {+ex:alice .Person ?author name}
            `,
            journal: `           
## 2024-07-18 ‚Äî A good day {=urn:journal:day-2024-07-18 .Event}

[ex] <http://example.org/>


Mood: [Happy] {mood}
Energy level: [8] {ex:energyLevel ^^xsd:integer}
Place: [Central Park] {=ex:central-park ?location}
Park label: [Central Park] {rdfs:label @en}
With: [Sam] {=ex:sam .Person ?attendee}
Weather: [Sunny] {ex:weather}

Activities: {?ex:hasActivity .Action name}

- Walking {=ex:walking-1}
- Reading {=ex:reading-1}

Reflections:
I felt [peaceful] {ex:emotionalState} and the park was [beautiful] {description}.

Related events: {!ex:relatedEvent  .Event}
- Morning coffee {=ex:coffee-2024-07-18}
- Evening dinner {=ex:dinner-2024-07-18}`,

            recipe: `
## Apple Pie {=urn:recipe:apple-pie .Recipe name}

Description: **Classic homemade apple pie** {description}
Cooking time: **45** {cookTime ^^xsd:integer} minutes
Servings: **8** {recipeYield ^^xsd:integer}
Difficulty: **Medium** {urn:skill:difficulty}

Ingredients: {?recipeIngredient .urn:food:ingredient name}

* Apples {=urn:food:apples}
* Sugar {=urn:food:sugar}
* Butter {=urn:food:butter}
* Flour {=urn:food:flour}
* Cinnamon {=urn:food:cinnamon}

_Ingredient_ {+urn:food:ingredient .Class name} - is a class for all ingredients in our **Cookbook** {+urn:collection:cookbook .Collection name ?isPartOf}.

Equipment: {?urn:requiresEquipment name}

* Oven {=urn:kitchen:oven-1 .Device }
* Mixing bowl {=urn:kitchen:bowl-1 .Utensil }
* Rolling pin {=urn:kitchen:pin-1 .Utensil }

Calories:  [1235] {urn:nutrition:calories ^^xsd:integer} calories
Sugar: [40.4] {urn:nutrition:sugarGrams ^^xsd:decimal} grams

Related recipes: {!urn:class:variationOf .Recipe name}

* Apple Crumble {=urn:recipe:apple-crumble}
* Peach Pie {=urn:recipe:peach-pie}
            `,

            project: `
[ex] <http://example.org/>

## Weekend goals {=ex:weekend-goals .Project}

Tasks: {?hasPart .Action name}
- Clean kitchen {=ex:task-clean} 
- Fix bike {=ex:task-bike} 
- Read book {=ex:task-read}

Dependencies: {?dependsOn .Store name}
- Hardware store {=ex:hardware-store }

People involved: {?assignedTo .Person name}
- Myself {=ex:myself}

Blocked by: {!blocks name}
- Rain forecast {=ex:weather-forecast}

Progress tracking: {?hasMilestone .Achievement name}
- Kitchen cleaned {=ex:milestone-kitchen}
- Bike fixed {=ex:milestone-bike}`,

            apollo: `# Apollo 11 {=wd:Q43653 .SpaceMission}

[ex] <http://example.org/>

Mission name: [Apollo 11] {name}
Label: [Apollo 11] {rdfs:label @en}
Launch year: [1969] {startDate ^^xsd:gYear}
Landing date: [1969-07-20] {endDate ^^xsd:date}
Duration: [8] {ex:durationDays ^^xsd:integer}
Budget: [2.5] {ex:billionUSD ^^xsd:decimal}

Crew: {?hasPart .Person name}

- Neil Armstrong {=wd:Q1615}
- Buzz Aldrin {=wd:Q2252} 
- Michael Collins {=wd:Q298} 

Equipment: {?ex:hasEquipment name}

- Saturn V {=ex:saturn-v}
- Lunar Module {=ex:lm-eagle}
- Command Module {=ex:cm-columbia}

Mission objectives: {?ex:objective .Goal name}
- Land on Moon {ex:goal-land}
- Return safely {ex:goal-return}
- Collect samples {ex:goal-sample}

Related missions: {!ex:precededBy .SpaceMission name}
- Apollo 10 {=wd:Q2705}

Followed by: {!ex:followedBy .SpaceMission name}
- Apollo 12 {=wd:Q2707}`
        };

        // Load example
        window.loadExample = function (name) {
            document.getElementById('input').value = examples[name];
            parseMDLD();
        };

        let lastParse = null;

        function escapeHtml(s) {
            return String(s)
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#39;');
        }

        function short(term, ctx) {
            return shortenIRI(term, ctx);
        }

        function clipTitle(full, display) {
            return display === full ? display : `${display}\n${full}`;
        }

        function chip(kind, fullValue, displayValue, extraClass = '') {
            const d = escapeHtml(displayValue);
            const t = escapeHtml(clipTitle(fullValue, displayValue));

            let borderColor = 'var(--border-chip-default)';
            let bgColor = 'var(--bg-chip-default)';
            let keyColor = 'var(--text-chip-key)';

            if (extraClass === 'q-s') {
                borderColor = 'var(--border-chip-subject)';
                bgColor = 'var(--bg-chip-subject)';
                keyColor = 'var(--text-chip-subject)';
            } else if (extraClass === 'q-p') {
                borderColor = 'var(--border-chip-predicate)';
                bgColor = 'var(--bg-chip-predicate)';
                keyColor = 'var(--text-chip-predicate)';
            } else if (extraClass === 'q-o') {
                borderColor = 'var(--border-chip-object)';
                bgColor = 'var(--bg-chip-object)';
                keyColor = 'var(--text-chip-object)';
            } else if (extraClass === 'q-lit') {
                borderColor = 'var(--border-chip-literal)';
                bgColor = 'var(--bg-chip-literal)';
                keyColor = 'var(--text-chip-literal)';
            }

            return `<span style="display: inline-flex; align-items: center; gap: .35rem; max-width: 100%; border: 1px solid ${borderColor}; background: ${bgColor}; border-radius: 6px; padding: .12rem .4rem;">
                <span style="display: inline-block; max-width: 48ch; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${t}">${d}</span></span>`;
        }


        function quadKey(quad) {
            const o = quad.object;
            const oKey = o.termType === 'Literal'
                ? JSON.stringify({ t: 'L', v: o.value, lang: o.language || '', dt: o.datatype?.value || '' })
                : JSON.stringify({ t: o.termType, v: o.value });
            return JSON.stringify([quad.subject.value, quad.predicate.value, oKey]);
        }

        function parseObjectField(raw) {
            const s = String(raw || '').trim();
            if (!s) return null;
            if (s.startsWith('"')) {
                const m = s.match(/^"([\s\S]*)"(?:@([a-zA-Z-]+)|\^\^<([^>]+)>|\^\^([^\s]+))?$/);
                if (!m) return { termType: 'Literal', value: s.replace(/^"|"$/g, ''), language: '', datatype: { termType: 'NamedNode', value: 'http://www.w3.org/2001/XMLSchema#string' } };
                const value = m[1].replace(/\\"/g, '"');
                if (m[2]) return { termType: 'Literal', value, language: m[2], datatype: { termType: 'NamedNode', value: 'http://www.w3.org/1999/02/22-rdf-syntax-ns#langString' } };
                const dt = m[3] || m[4];
                if (dt) return { termType: 'Literal', value, language: '', datatype: { termType: 'NamedNode', value: dt.startsWith('http') ? dt : dt } };
                return { termType: 'Literal', value, language: '', datatype: { termType: 'NamedNode', value: 'http://www.w3.org/2001/XMLSchema#string' } };
            }
            const iri = s.startsWith('<') && s.endsWith('>') ? s.slice(1, -1) : s;
            return { termType: 'NamedNode', value: iri };
        }

        // Parse MD-LD
        window.parseMDLD = function () {
            const input = document.getElementById('input').value;
            const output = document.getElementById('output');
            // const rendered = document.getElementById('rendered-output');
            const stats = document.getElementById('parse-stats');

            if (!input.trim()) {
                output.textContent = 'Quads will appear here...';
                // rendered.textContent = 'Rendered HTML will appear here...';
                stats.textContent = '';
                return;
            }

            try {
                const startTime = performance.now();
                const result = parse(input, { context: { ex: 'http://example.org/' } });
                // const renderedResult = render(input, { context: { ex: 'http://example.org/' } });
                const duration = Math.round(performance.now() - startTime);

                lastParse = { input, result };

                // Display rendered HTML+RDFa
                // rendered.innerHTML = `<div style="background: white; padding: 1rem; border-radius: 4px;">${renderedResult.text}</div>`;

                // Convert quads to readable format
                output.innerHTML = quadsToHtml(result.quads);
                stats.textContent = `${result.quads.length} triples ‚Ä¢ ${duration}ms`;

                quadLabReset();
            } catch (error) {
                output.textContent = `Error: ${error.message}`;
                rendered.textContent = `Error: ${error.message}`;
                stats.textContent = '';
            }
        };

        function quadsToHtml(quads) {
            if (!quads || quads.length === 0) return '<div style="color: var(--text-muted);"># No quads generated</div>';
            return quads.map(q => {
                const ctx = lastParse?.result?.context || {};
                const sFull = q.subject.value;
                const pFull = q.predicate.value;
                const sDisp = short(sFull, ctx);
                const pDisp = short(pFull, ctx);

                const s = chip('S', sFull, sDisp, 'q-s');
                const p = chip('P', pFull, pDisp, 'q-p');

                let o;
                if (q.object.termType === 'Literal') {
                    o = chip('L', formatLiteral(q.object), formatLiteral(q.object), 'q-lit');
                } else {
                    const oFull = q.object.value;
                    const oDisp = short(oFull, ctx);
                    o = chip('O', oFull, oDisp, 'q-o');
                }

                return `<div style="display: flex; gap: .4rem; align-items: center; padding: .2rem 0; border-bottom: 1px dashed var(--border-dark); min-width: 0;">${s}<span style="color: var(--text-separator);">‚Üí</span>${p}<span style="color: var(--text-separator);">‚Üí</span>${o}</div>`;
            }).join('');
        }

        // Format literal with datatype/language
        function formatLiteral(literal) {
            let value = literal.value.replace(/"/g, '\\"');
            let result = `"${value}"`;

            if (literal.language) {
                result += `@${literal.language}`;
            } else if (literal.datatype && literal.datatype.value && literal.datatype.value !== 'http://www.w3.org/2001/XMLSchema#string') {
                result += `^^<${literal.datatype.value}>`;
            }

            return result;
        }

        // Clear playground
        window.clearPlayground = function () {
            document.getElementById('input').value = '';
            document.getElementById('output').textContent = 'Quads will appear here...';
            document.getElementById('rendered-output').textContent = 'Rendered HTML will appear here...';
            document.getElementById('parse-stats').textContent = '';
            document.getElementById('quadlab-body').innerHTML = '';
            document.getElementById('quadlab-diff').textContent = 'Diff will appear here...';
            document.getElementById('quadlab-stats').textContent = '';
        };

        function normalizeQuadFromFields(s, p, oField) {
            const S = String(s || '').trim();
            const P = String(p || '').trim();
            const O = parseObjectField(oField);
            if (!S || !P || !O) return null;
            return { subject: { termType: 'NamedNode', value: S }, predicate: { termType: 'NamedNode', value: P }, object: O, graph: { termType: 'NamedNode', value: '' } };
        }

        function quadToRow(quad, idx) {
            const tr = document.createElement('tr');
            tr.dataset.idx = String(idx);
            const oField = quad.object.termType === 'Literal' ? formatLiteral(quad.object) : `<${quad.object.value}>`;
            tr.innerHTML = `
                <td><input type="checkbox" data-role="sel" /></td>
                <td><input data-role="s" value="${escapeHtml(quad.subject.value)}" style="width: 100%; background: var(--bg-input); color: var(--text-code); border: 1px solid var(--border-dark); border-radius: 4px; padding: .25rem .4rem; font-family: var(--font-mono); font-size: 12px;" /></td>
                <td><input data-role="p" value="${escapeHtml(quad.predicate.value)}" style="width: 100%; background: var(--bg-input); color: var(--text-code); border: 1px solid var(--border-dark); border-radius: 4px; padding: .25rem .4rem; font-family: var(--font-mono); font-size: 12px;" /></td>
                <td><input data-role="o" value="${escapeHtml(oField)}" style="width: 100%; background: var(--bg-input); color: var(--text-code); border: 1px solid var(--border-dark); border-radius: 4px; padding: .25rem .4rem; font-family: var(--font-mono); font-size: 12px;" /></td>
            `;
            tr.addEventListener('input', () => quadLabUpdateDiff());
            tr.addEventListener('change', () => quadLabUpdateDiff());
            return tr;
        }

        function quadLabGetRows() {
            const rows = [...document.querySelectorAll('#quadlab-body tr')];
            return rows.map(tr => {
                const s = tr.querySelector('[data-role="s"]').value;
                const p = tr.querySelector('[data-role="p"]').value;
                const o = tr.querySelector('[data-role="o"]').value;
                return normalizeQuadFromFields(s, p, o);
            }).filter(Boolean);
        }

        function quadLabDiffFrom(last, next) {
            const lastMap = new Map((last || []).map(q => [quadKey(q), q]));
            const nextMap = new Map((next || []).map(q => [quadKey(q), q]));
            const del = [];
            const add = [];
            for (const [k, q] of lastMap) if (!nextMap.has(k)) del.push(q);
            for (const [k, q] of nextMap) if (!lastMap.has(k)) add.push(q);
            return { delete: del, add };
        }

        window.quadLabReset = function () {
            const body = document.getElementById('quadlab-body');
            body.innerHTML = '';
            const base = lastParse?.result?.quads || [];
            base.forEach((q, i) => body.appendChild(quadToRow(q, i)));
            quadLabUpdateDiff();
        };

        window.quadLabAddRow = function () {
            const body = document.getElementById('quadlab-body');
            const idx = body.children.length;
            const empty = {
                subject: { termType: 'NamedNode', value: 'http://example.org/s' },
                predicate: { termType: 'NamedNode', value: 'http://schema.org/name' },
                object: { termType: 'Literal', value: 'value', language: '', datatype: { termType: 'NamedNode', value: 'http://www.w3.org/2001/XMLSchema#string' } },
                graph: { termType: 'NamedNode', value: '' }
            };
            body.appendChild(quadToRow(empty, idx));
            quadLabUpdateDiff();
        };

        window.quadLabDeleteSelected = function () {
            const body = document.getElementById('quadlab-body');
            [...body.querySelectorAll('tr')].forEach(tr => {
                const sel = tr.querySelector('[data-role="sel"]');
                if (sel?.checked) tr.remove();
            });
            quadLabUpdateDiff();
        };

        function quadLabUpdateDiff() {
            const diffBox = document.getElementById('quadlab-diff');
            const stats = document.getElementById('quadlab-stats');
            const base = lastParse?.result?.quads || [];
            const next = quadLabGetRows();
            const diff = quadLabDiffFrom(base, next);
            const payload = { delete: diff.delete, add: diff.add };
            diffBox.textContent = JSON.stringify(payload, null, 2);
            stats.textContent = `${next.length} quads ‚Ä¢ +${diff.add.length} / -${diff.delete.length}`;
        }

        window.quadLabCopyDiff = async function () {
            const text = document.getElementById('quadlab-diff').textContent || '';
            try {
                await navigator.clipboard.writeText(text);
            } catch {
                // ignore
            }
        };

        window.quadLabApplyDiff = function () {
            if (!lastParse?.result?.origin) return;
            const inputEl = document.getElementById('input');
            const base = lastParse.result.quads || [];
            const next = quadLabGetRows();
            const diff = quadLabDiffFrom(base, next);

            const patched = serialize({
                text: inputEl.value,
                diff,
                origin: lastParse.result.origin,
                options: { context: lastParse.result.context }
            });

            inputEl.value = patched.text;
            parseMDLD();
        };

        window.toggleQuadLab = function () {
            const el = document.getElementById('quadlab');
            if (!el) return;
            el.classList.toggle('hidden');
        };

        // Run all tests
        window.runAllTests = async function () {
            const startTime = performance.now();
            currentTestResults = [];

            const progress = document.getElementById('test-progress');
            const progressBar = document.getElementById('test-progress-bar');
            const stats = document.getElementById('test-stats');
            const testList = document.getElementById('test-list');
            const status = document.getElementById('test-status');

            progress.style.display = 'block';
            stats.style.display = 'grid';
            testList.innerHTML = '';
            status.textContent = 'Running tests...';

            let passed = 0;
            let failed = 0;

            for (let i = 0; i < tests.length; i++) {
                const test = tests[i];
                const testStart = performance.now();

                try {
                    const result = test.fn();
                    const duration = Math.round(performance.now() - testStart);

                    currentTestResults.push({
                        name: test.name,
                        status: 'passed',
                        duration,
                        result
                    });

                    passed++;
                    addTestItem(test.name, 'passed', duration, result);
                } catch (error) {
                    const duration = Math.round(performance.now() - testStart);

                    currentTestResults.push({
                        name: test.name,
                        status: 'failed',
                        duration,
                        error: error.message
                    });

                    failed++;
                    addTestItem(test.name, 'failed', duration, null, error.message);
                }

                const progressPercent = ((i + 1) / tests.length) * 100;
                progressBar.style.width = `${progressPercent}%`;

                document.getElementById('passed-count').textContent = passed;
                document.getElementById('failed-count').textContent = failed;
                document.getElementById('total-count').textContent = tests.length;

                await new Promise(resolve => setTimeout(resolve, 5));
            }

            const totalDuration = Math.round(performance.now() - startTime);
            document.getElementById('duration').textContent = `${totalDuration}ms`;

            setTimeout(() => {
                progress.style.display = 'none';
                status.textContent = `Completed: ${passed} passed, ${failed} failed`;
            }, 500);
        };

        // Add test item to UI
        function addTestItem(name, status, duration, result, error = null) {
            const testList = document.getElementById('test-list');
            const item = document.createElement('div');

            let borderLeft = 'none';
            if (status === 'passed') {
                borderLeft = '3px solid var(--color-success)';
            } else if (status === 'failed') {
                borderLeft = '3px solid var(--color-error)';
            }

            item.style.cssText = `background: var(--bg-feature); border: 1px solid var(--border-dark); border-radius: 4px; padding: .75rem; margin-bottom: .25rem; transition: all .2s; border-left: ${borderLeft};`;

            const icon = status === 'passed' ? '‚úÖ' : '‚ùå';

            item.innerHTML = `
        <div style="display: flex; align-items: center; gap: .5rem; margin-bottom: .5rem;">
          <span style="font-size: 1rem;">${icon}</span>
          <span style="flex: 1; font-weight: 500; font-size: .875rem; font-family: var(--font);">${name}</span>
          <span style="font-size: .75rem; color: var(--text-muted);">${duration}ms</span>
        </div>
        <div style="margin-top: .5rem; padding-top: .5rem; border-top: 1px solid var(--border-dark); display: none;" id="details-${name.replace(/\s+/g, '-')}">
          ${result ? `
            <div style="background: var(--bg-input); padding: .5rem; border-radius: 4px; font-family: var(--font-mono); font-size: 11px; white-space: pre-wrap; max-height: 150px; overflow-y: auto; margin-bottom: .5rem; color: var(--text-code); user-select: text;">${result.input}</div>
            <div style="background: var(--bg-input); padding: .5rem; border-radius: 4px; font-family: var(--font-mono); font-size: 11px; white-space: pre-wrap; max-height: 150px; overflow-y: auto; margin-bottom: .5rem; color: var(--text-code); user-select: text;">${(result.output.quads || []).map(q => `${q.subject.value} -> ${q.predicate.value} -> ${q.object.termType === 'Literal' ? formatLiteral(q.object) : `<${q.object.value}>`}`).join('\n')}</div>
          ` : ''}
          ${error ? `<div style="color: var(--color-error); font-family: var(--font-mono); font-size: 11px;">${error}</div>` : ''}
        </div>
      `;

            item.addEventListener('click', () => {
                const details = item.querySelector(`#details-${name.replace(/\s+/g, '-')}`);
                details.style.display = details.style.display === 'none' ? 'block' : 'none';
            });

            testList.appendChild(item);
        }

        // Clear tests
        window.clearTests = function () {
            currentTestResults = [];
            document.getElementById('test-list').innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 1rem;">Click "Run Tests" to see results</p>';
            document.getElementById('test-stats').style.display = 'none';
            document.getElementById('test-progress').style.display = 'none';
            document.getElementById('test-status').textContent = '';
        };

        // Auto-parse on input change
        document.getElementById('input').addEventListener('input', () => {
            clearTimeout(window.parseTimeout);
            window.parseTimeout = setTimeout(parseMDLD, 300);
        });

        // Auto-run tests on page load
        window.addEventListener('load', () => {
            setTimeout(() => {
                runAllTests();
            }, 500);
        });

        // Load initial example
        loadExample('journal');
    </script>
</body>

</html>