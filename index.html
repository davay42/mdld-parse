<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MD-LD - Markdown Linked Data Parser</title>
    <meta name="description"
        content="MD-LD v0.2: Human-friendly RDF authoring format. Write semantic data in natural Markdown. Parse to RDF triples. Zero dependencies.">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', monospace;
            line-height: 1.5;
            color: #e5e7eb;
            background: #111827
        }

        code {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem
        }

        header {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #374151
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: .5rem;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent
        }

        .tagline {
            font-size: 1rem;
            color: #9ca3af;
            margin-bottom: 1rem
        }

        .links {
            display: flex;
            gap: .5rem;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 1rem
        }

        .links a {
            color: #60a5fa;
            text-decoration: none;
            padding: .25rem .75rem;
            border: 1px solid #374151;
            border-radius: 4px;
            font-size: .875rem;
            transition: all .2s
        }

        .links a:hover {
            background: #374151;
            border-color: #60a5fa
        }

        .format-section {
            background: #1f2937;
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 1rem
        }

        .format-section h3 {
            margin-bottom: .5rem;
            color: #f3f4f6;
            font-size: 1rem
        }

        .format-section p {
            color: #9ca3af;
            font-size: .875rem;
            margin-bottom: .5rem
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: .5rem
        }

        .feature {
            background: #111827;
            border: 1px solid #374151;
            border-radius: 4px;
            padding: .5rem
        }

        .feature h4 {
            margin-bottom: .25rem;
            color: #f3f4f6;
            font-size: .875rem
        }

        .feature p {
            color: #9ca3af;
            font-size: .75rem
        }

        .examples {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: .5rem;
            margin-bottom: 1rem
        }

        .example {
            background: #1f2937;
            border: 1px solid #374151;
            border-radius: 4px;
            padding: .75rem;
            cursor: pointer;
            transition: all .2s
        }

        .example:hover {
            border-color: #60a5fa
        }

        .example h4 {
            margin-bottom: .25rem;
            color: #f3f4f6;
            font-size: .875rem
        }

        .example p {
            font-size: .75rem;
            color: #9ca3af
        }

        .playground {
            display: grid;
            grid-template-columns: minmax(360px, 1.2fr) minmax(360px, 1fr) minmax(360px, 1fr);
            gap: 1rem;
            margin-bottom: 1rem;
            align-items: start
        }

        .playground>* {
            min-width: 0
        }

        .textarea {
            width: 100%;
            height: 250px;
            padding: .75rem;
            border: 1px solid #374151;
            border-radius: 4px;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
            font-size: 13px;
            resize: vertical;
            background: #1f2937;
            color: #e5e7eb
        }

        .textarea:focus {
            outline: none;
            border-color: #60a5fa
        }

        .output {
            background: #1f2937;
            border: 1px solid #374151;
            border-radius: 4px;
            padding: .75rem;
            height: 250px;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            overflow: auto;
            color: #e5e7eb
        }

        .controls {
            display: flex;
            gap: .5rem;
            margin-bottom: 1rem;
            align-items: center
        }

        .hidden {
            display: none
        }

        button {
            background: #3b82f6;
            color: #fff;
            border: none;
            padding: .5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            font-size: .875rem;
            transition: all .2s
        }

        button:hover {
            background: #2563eb
        }

        button:disabled {
            background: #6b7280;
            cursor: not-allowed
        }

        button.secondary {
            background: #4b5563
        }

        button.secondary:hover {
            background: #6b7280
        }

        .compact-stats {
            display: flex;
            gap: 1rem;
            font-size: .875rem;
            color: #9ca3af
        }

        .muted {
            color: #9ca3af
        }

        .kv {
            display: flex;
            gap: .75rem;
            flex-wrap: wrap
        }

        .pill {
            border: 1px solid #374151;
            background: #111827;
            border-radius: 999px;
            padding: .1rem .5rem;
            font-size: .75rem;
            color: #cbd5e1
        }

        .mdld-preview {
            white-space: pre-wrap;
            user-select: text
        }

        .mdld-ann {
            opacity: .5;
            background: #0b1220;
            border: 1px solid #22304a;
            border-radius: 3px;
            padding: 0 .15rem
        }

        .mdld-carrier {
            color: #e5e7eb
        }

        .quad {
            display: flex;
            gap: .4rem;
            align-items: center;
            padding: .2rem 0;
            border-bottom: 1px dashed #374151;
            min-width: 0
        }

        .quad:last-child {
            border-bottom: none
        }

        .q-sep {
            color: #64748b
        }

        .q-chip {
            display: inline-flex;
            align-items: center;
            gap: .35rem;
            max-width: 100%;
            border: 1px solid #334155;
            background: #0b1220;
            border-radius: 6px;
            padding: .12rem .4rem
        }

        .q-k {
            font-size: .68rem;
            letter-spacing: .06em;
            text-transform: uppercase;
            color: #94a3b8
        }

        .q-v {
            display: inline-block;
            max-width: 48ch;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap
        }

        .q-s {
            border-color: #1e3a8a;
            background: #0b1730
        }

        .q-s .q-k {
            color: #93c5fd
        }

        .q-p {
            border-color: #334155;
            background: #0b1220
        }

        .q-p .q-k {
            color: #e2e8f0
        }

        .q-o {
            border-color: #3f3f46;
            background: #0f172a
        }

        .q-o .q-k {
            color: #a1a1aa
        }

        .q-lit {
            border-color: #44403c;
            background: #15110f
        }

        .q-lit .q-k {
            color: #f5f5f4
        }

        .crud {
            margin-top: .75rem
        }

        .crud-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem
        }

        .crud-table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid #374151;
            border-radius: 4px;
            overflow: hidden
        }

        .crud-table th,
        .crud-table td {
            border-bottom: 1px solid #374151;
            padding: .35rem .5rem;
            text-align: left;
            font-size: .8rem
        }

        .crud-table th {
            background: #111827;
            color: #cbd5e1;
            font-weight: 600
        }

        .crud-table tr:hover td {
            background: #0f172a
        }

        .crud-input {
            width: 100%;
            background: #0f172a;
            color: #e5e7eb;
            border: 1px solid #374151;
            border-radius: 4px;
            padding: .25rem .4rem;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
            font-size: 12px
        }

        .crud-input:focus {
            outline: none;
            border-color: #60a5fa
        }

        .danger {
            background: #ef4444
        }

        .danger:hover {
            background: #dc2626
        }

        .test-section {
            background: #1f2937;
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 1rem
        }

        .test-controls {
            display: flex;
            gap: .5rem;
            margin-bottom: .5rem;
            align-items: center
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: .5rem;
            margin-bottom: .5rem
        }

        .stat {
            background: #111827;
            padding: .5rem;
            border-radius: 4px;
            text-align: center;
            border: 1px solid #374151
        }

        .stat-value {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: .25rem
        }

        .stat-label {
            font-size: .75rem;
            color: #9ca3af
        }

        .passed {
            color: #10b981
        }

        .failed {
            color: #ef4444
        }

        .total {
            color: #60a5fa
        }

        .test-list {
            max-height: 300px;
            overflow-y: auto
        }

        .test-item {
            background: #111827;
            border: 1px solid #374151;
            border-radius: 4px;
            padding: .75rem;
            margin-bottom: .25rem;
            transition: all .2s
        }

        .test-item:hover {
            border-color: #60a5fa
        }

        .test-item.passed {
            border-left: 3px solid #10b981
        }

        .test-item.failed {
            border-left: 3px solid #ef4444
        }

        .test-header {
            display: flex;
            align-items: center;
            gap: .5rem;
            margin-bottom: .5rem
        }

        .test-icon {
            font-size: 1rem
        }

        .test-name {
            flex: 1;
            font-weight: 500;
            font-size: .875rem
        }

        .test-duration {
            font-size: .75rem;
            color: #9ca3af
        }

        .test-details {
            margin-top: .5rem;
            padding-top: .5rem;
            border-top: 1px solid #374151;
            display: none
        }

        .test-details.open {
            display: block
        }

        .test-input,
        .test-output {
            background: #0f172a;
            padding: .5rem;
            border-radius: 4px;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
            font-size: 11px;
            white-space: pre-wrap;
            max-height: 150px;
            overflow-y: auto;
            margin-bottom: .5rem;
            color: #e5e7eb;
            user-select: text
        }

        .progress {
            height: 3px;
            background: #374151;
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: .5rem
        }

        .progress-bar {
            height: 100%;
            background: #3b82f6;
            transition: width .3s ease
        }

        @media (max-width: 900px) {
            .playground {
                grid-template-columns: 1fr
            }
        }

        @media (max-width: 768px) {
            .stats {
                grid-template-columns: repeat(2, 1fr)
            }

            h1 {
                font-size: 2rem
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>MD-LD</h1>
            <p class="tagline">Markdown Linked Data - Human-friendly RDF authoring</p>
            <div class="links">
                <a href="https://github.com/davay42/mdld-parse" target="_blank">üì¶ GitHub</a>
                <a href="https://www.npmjs.com/package/mdld-parse" target="_blank">üì¶ npm</a>
                <a href="#format">üìñ Format</a>
                <a href="#tests">üß™ Tests</a>
            </div>
        </header>

        <section id="format" class="format-section">
            <h3>üìñ What is MD-LD?</h3>
            <p>MD-LD extends Markdown with semantic annotations using <code>{...}</code> blocks. Write natural language
                documents while embedding structured RDF data.</p>

            <div class="feature-grid">
                <div class="feature">
                    <h4>üìù Natural Syntax</h4>
                    <p>Write semantic data in familiar Markdown</p>
                </div>
                <div class="feature">
                    <h4>üîó RDF Output</h4>
                    <p>Parse to standard RDF triples</p>
                </div>
                <div class="feature">
                    <h4>‚ö° Zero Dependencies</h4>
                    <p>Lightweight parser</p>
                </div>
                <div class="feature">
                    <h4>üîÑ Bidirectional</h4>
                    <p>Parse & serialize round-trip</p>
                </div>
            </div>
        </section>

        <section id="playground" class="format-section">
            <h3>üéÆ Interactive Playground</h3>
            <div class="kv" style="margin-bottom: .5rem;">
                <span class="pill">MD-LD highlight</span>
                <span class="pill">Quad highlight</span>
                <span class="pill">Quad CRUD ‚Üí diff ‚Üí serialize()</span>
            </div>
            <div class="examples">
                <div class="example" onclick="loadExample('journal')">
                    <h4>üìî Personal Journal</h4>
                    <p>Mood, location, people</p>
                </div>
                <div class="example" onclick="loadExample('recipe')">
                    <h4>üç≥ Recipe</h4>
                    <p>Ingredients & instructions</p>
                </div>
                <div class="example" onclick="loadExample('project')">
                    <h4>üìã Project</h4>
                    <p>Tasks & relationships</p>
                </div>
                <div class="example" onclick="loadExample('apollo')">
                    <h4>üöÄ Apollo Mission</h4>
                    <p>Complex structure</p>
                </div>
            </div>
            <div class="playground">
                <div>
                    <h3>MD-LD Input</h3>
                    <textarea id="input" class="textarea" placeholder="Write your MD-LD here...

Example:
## Document {=ex:doc}
Title: [My Document] {name}
Author: [Alice] {=ex:alice .Person ?author}"></textarea>
                </div>
                <div>
                    <h3>Quads (highlighted)</h3>
                    <div id="output" class="output">Quads will appear here...</div>
                </div>
                <div>
                    <h3>MD-LD (highlighted)</h3>
                    <div id="mdld-preview" class="output mdld-preview">MD-LD preview will appear here...</div>
                </div>
            </div>
            <div class="controls">
                <button onclick="parseMDLD()">üîÑ Parse MD-LD</button>
                <button class="secondary" onclick="clearPlayground()">üóëÔ∏è Clear</button>
                <button class="secondary" onclick="toggleQuadLab()">üß© Quad Lab</button>
                <span id="parse-stats" class="compact-stats" style="margin-left: auto;"></span>
            </div>

            <div class="crud hidden" id="quadlab">
                <h3>üß© Quad Lab (CRUD + diff apply)</h3>
                <p class="muted">Edit quads below. Applying changes generates a diff and calls <code>serialize()</code>
                    to patch the MD-LD source.</p>
                <div class="controls" style="margin-bottom:.5rem;">
                    <button class="secondary" onclick="quadLabReset()">‚Ü© Reset from parse()</button>
                    <button onclick="quadLabAddRow()">‚ûï Add quad</button>
                    <button class="danger" onclick="quadLabDeleteSelected()">üóë Delete selected</button>
                    <span id="quadlab-stats" class="compact-stats" style="margin-left:auto;"></span>
                </div>
                <div class="crud-grid">
                    <div>
                        <table class="crud-table" id="quadlab-table">
                            <thead>
                                <tr>
                                    <th style="width: 2.5rem;">Sel</th>
                                    <th>S</th>
                                    <th>P</th>
                                    <th>O</th>
                                </tr>
                            </thead>
                            <tbody id="quadlab-body"></tbody>
                        </table>
                    </div>
                    <div>
                        <div class="output" id="quadlab-diff">Diff will appear here...</div>
                        <div class="controls" style="margin-top:.5rem;margin-bottom:0;">
                            <button onclick="quadLabApplyDiff()">‚úÖ Apply diff via serialize()</button>
                            <button class="secondary" onclick="quadLabCopyDiff()">üìã Copy diff JSON</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="tests" class="test-section">
            <h3>üß™ Test Suite</h3>
            <div class="test-controls">
                <button onclick="runAllTests()">‚ñ∂ Run Tests</button>
                <button class="secondary" onclick="clearTests()">üóëÔ∏è Clear</button>
                <span id="test-status" class="compact-stats" style="margin-left: auto;"></span>
            </div>
            <div class="progress" id="test-progress" style="display: none;">
                <div class="progress-bar" id="test-progress-bar"></div>
            </div>
            <div class="stats" id="test-stats" style="display: none;">
                <div class="stat">
                    <div class="stat-value passed" id="passed-count">0</div>
                    <div class="stat-label">Passed</div>
                </div>
                <div class="stat">
                    <div class="stat-value failed" id="failed-count">0</div>
                    <div class="stat-label">Failed</div>
                </div>
                <div class="stat">
                    <div class="stat-value total" id="total-count">0</div>
                    <div class="stat-label">Total</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="duration">0ms</div>
                    <div class="stat-label">Duration</div>
                </div>
            </div>
            <div class="test-list" id="test-list">
                <p style="text-align: center; color: #9ca3af; padding: 1rem;">Tests will run automatically on page
                    load...</p>
            </div>
        </section>
    </div>

    <script type="importmap">
  {
    "imports": {
      "./index.js": "./index.js",
      "./tests.js": "./tests.js"
    }
  }
  </script>

    <script type="module">
        import { parse, serialize, shortenIRI } from './index.js';
        import { runTests, tests } from './tests.js';

        let currentTestResults = [];

        // Example templates
        const examples = {
            journal: `           
## 2024-07-18 ‚Äî A good day {=urn:journal:day-2024-07-18 .Event}

[ex] {: http://example.org/}


Mood: [Happy] {mood}
Energy level: [8] {ex:energyLevel ^^xsd:integer}
Place: [Central Park] {=ex:central-park ?location}
Park label: [Central Park] {rdfs:label @en}
With: [Sam] {=ex:sam .Person ?attendee}
Weather: [Sunny] {ex:weather}

Activities: {ex:hasActivity .Action}

- Walking {=ex:walking-1 name}
- Reading {=ex:reading-1 name}

Reflections:
I felt [peaceful] {ex:emotionalState} and the park was [beautiful] {description}.

Related events: {^?ex:relatedEvent}
- Morning coffee {=ex:coffee-2024-07-18 .Event}
- Evening dinner {=ex:dinner-2024-07-18 .Event}`,

            recipe: `
## Apple Pie {=urn:recipe:apple-pie .Recipe name}

Description: **Classic homemade apple pie** {description}
Cooking time: **45** {cookTime ^^xsd:integer} minutes
Servings: **8** {recipeYield ^^xsd:integer}
Difficulty: **Medium** {urn:skill:difficulty}

Ingredients: {recipeIngredient .urn:food:ingredient}

* Apples {=urn:food:apples .urn:food:ingredient name}
* Sugar {=urn:food:sugar .urn:food:ingredient name}
* Butter {=urn:food:butter .urn:food:ingredient name}
* Flour {=urn:food:flour .urn:food:ingredient name}
* Cinnamon {=urn:food:cinnamon .urn:food:ingredient name}

_Ingredient_ {=?urn:food:ingredient .Class name} - is a class for all ingredients in our **Cookbook** {=?urn:collection:cookbook .Collection name ?isPartOf}.

Equipment: {urn:requiresEquipment}

* Oven {=urn:kitchen:oven-1 .Device name}
* Mixing bowl {=urn:kitchen:bowl-1 .Utensil name}
* Rolling pin {=urn:kitchen:pin-1 .Utensil name}

Calories:  [1235] {urn:nutrition:calories ^^xsd:integer} calories
Sugar: [40.4] {urn:nutrition:sugarGrams ^^xsd:decimal} grams

Related recipes: {^?urn:class:variationOf .Recipe}

* Apple Crumble {=urn:recipe:apple-crumble .Recipe name}
* Peach Pie {=urn:recipe:peach-pie .Recipe name}
            `,

            project: `
[ex] {: http://example.org/}

## Weekend goals {=ex:weekend-goals .Project}

Tasks: {hasPart .Action}
- Clean kitchen {=ex:task-clean name} [2 hours] {ex:estimatedTime}
- Fix bike {=ex:task-bike name} [1 hour] {ex:estimatedTime}
- Read book {=ex:task-read name} [3 hours] {ex:estimatedTime}

Dependencies: {dependsOn .Store}
- Hardware store {=ex:hardware-store name}

People involved: {assignedTo .Person}
- Myself {=ex:myself name}

Blocked by: {^?blocks}
- Rain forecast {=ex:weather-forecast name}

Progress tracking: {hasMilestone .Achievement}
- Kitchen cleaned {=ex:milestone-kitchen name}
- Bike fixed {=ex:milestone-bike name}`,

            apollo: `# Apollo 11 {=wd:Q43653 .SpaceMission}

[ex] {: http://example.org/}

Mission name: [Apollo 11] {name}
Label: [Apollo 11] {rdfs:label @en}
Launch year: [1969] {startDate ^^xsd:gYear}
Landing date: [1969-07-20] {endDate ^^xsd:date}
Duration: [8] {ex:durationDays ^^xsd:integer}
Budget: [2.5] {ex:billionUSD ^^xsd:decimal}

Crew: {hasPart .Person}

- Neil Armstrong {=wd:Q1615 name} [Commander] {ex:role}
- Buzz Aldrin {=wd:Q2252 name} [Lunar Module Pilot] {ex:role}
- Michael Collins {=wd:Q298 name} [Command Module Pilot] {ex:role}

Equipment: {ex:hasEquipment}

- Saturn V {=ex:saturn-v name} [7.6 million lbs] {ex:thrust}
- Lunar Module {=ex:lm-eagle name} [Eagle] {ex:callsign}
- Command Module {=ex:cm-columbia name} [Columbia] {ex:callsign}

Mission objectives: {ex:objective .Goal}

- Land on Moon {name} [Achieved] {ex:status}
- Return safely {name} [Achieved] {ex:status}
- Collect samples {name} [Achieved] {ex:status}

Related missions: {^?ex:precededBy .SpaceMission}
- Apollo 10 {=wd:Q2705 name}

Followed by: {^?ex:followedBy .SpaceMission}
- Apollo 12 {=wd:Q2707 name}`
        };

        // Load example
        window.loadExample = function (name) {
            document.getElementById('input').value = examples[name];
            parseMDLD();
        };

        let lastParse = null;

        function escapeHtml(s) {
            return String(s)
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#39;');
        }

        function short(term, ctx) {
            return shortenIRI(term, ctx);
        }

        function clipTitle(full, display) {
            return display === full ? display : `${display}\n${full}`;
        }

        function chip(kind, fullValue, displayValue, extraClass = '') {
            const d = escapeHtml(displayValue);
            const t = escapeHtml(clipTitle(fullValue, displayValue));
            return `<span class="q-chip ${extraClass}"><span class="q-k">${kind}</span><span class="q-v" title="${t}">${d}</span></span>`;
        }

        function highlightMdld(text) {
            const src = String(text || '');
            let out = '';
            let i = 0;
            while (i < src.length) {
                const open = src.indexOf('{', i);
                if (open === -1) {
                    out += escapeHtml(src.slice(i));
                    break;
                }
                out += escapeHtml(src.slice(i, open));
                let depth = 0;
                let j = open;
                while (j < src.length) {
                    const ch = src[j];
                    if (ch === '{') depth++;
                    if (ch === '}') {
                        depth--;
                        if (depth === 0) {
                            j++;
                            break;
                        }
                    }
                    j++;
                }
                const block = src.slice(open, j);
                out += `<span class="mdld-ann">${escapeHtml(block)}</span>`;
                i = j;
            }
            return out;
        }

        function quadKey(quad) {
            const o = quad.object;
            const oKey = o.termType === 'Literal'
                ? JSON.stringify({ t: 'L', v: o.value, lang: o.language || '', dt: o.datatype?.value || '' })
                : JSON.stringify({ t: o.termType, v: o.value });
            return JSON.stringify([quad.subject.value, quad.predicate.value, oKey]);
        }

        function parseObjectField(raw) {
            const s = String(raw || '').trim();
            if (!s) return null;
            if (s.startsWith('"')) {
                const m = s.match(/^"([\s\S]*)"(?:@([a-zA-Z-]+)|\^\^<([^>]+)>|\^\^([^\s]+))?$/);
                if (!m) return { termType: 'Literal', value: s.replace(/^"|"$/g, ''), language: '', datatype: { termType: 'NamedNode', value: 'http://www.w3.org/2001/XMLSchema#string' } };
                const value = m[1].replace(/\\"/g, '"');
                if (m[2]) return { termType: 'Literal', value, language: m[2], datatype: { termType: 'NamedNode', value: 'http://www.w3.org/1999/02/22-rdf-syntax-ns#langString' } };
                const dt = m[3] || m[4];
                if (dt) return { termType: 'Literal', value, language: '', datatype: { termType: 'NamedNode', value: dt.startsWith('http') ? dt : dt } };
                return { termType: 'Literal', value, language: '', datatype: { termType: 'NamedNode', value: 'http://www.w3.org/2001/XMLSchema#string' } };
            }
            const iri = s.startsWith('<') && s.endsWith('>') ? s.slice(1, -1) : s;
            return { termType: 'NamedNode', value: iri };
        }

        // Parse MD-LD
        window.parseMDLD = function () {
            const input = document.getElementById('input').value;
            const output = document.getElementById('output');
            const preview = document.getElementById('mdld-preview');
            const stats = document.getElementById('parse-stats');

            if (!input.trim()) {
                output.textContent = 'Enter MD-LD content to parse...';
                preview.textContent = 'MD-LD preview will appear here...';
                stats.textContent = '';
                return;
            }

            try {
                const startTime = performance.now();
                // Only provide context for ex prefix, rely on default context for schema.org
                const result = parse(input, { context: { ex: 'http://example.org/' } });
                const duration = Math.round(performance.now() - startTime);

                lastParse = { input, result };

                preview.innerHTML = highlightMdld(input);

                // Convert quads to readable format
                output.innerHTML = quadsToHtml(result.quads);
                stats.textContent = `${result.quads.length} triples ‚Ä¢ ${duration}ms`;

                quadLabReset();
            } catch (error) {
                output.textContent = `Error: ${error.message}`;
                preview.textContent = 'MD-LD preview will appear here...';
                stats.textContent = '';
            }
        };

        function quadsToHtml(quads) {
            if (!quads || quads.length === 0) return '<div class="muted"># No quads generated</div>';
            return quads.map(q => {
                const ctx = lastParse?.result?.context || {};
                const sFull = q.subject.value;
                const pFull = q.predicate.value;
                const sDisp = short(sFull, ctx);
                const pDisp = short(pFull, ctx);

                const s = chip('S', sFull, sDisp, 'q-s');
                const p = chip('P', pFull, pDisp, 'q-p');

                let o;
                if (q.object.termType === 'Literal') {
                    o = chip('L', formatLiteral(q.object), formatLiteral(q.object), 'q-lit');
                } else {
                    const oFull = q.object.value;
                    const oDisp = short(oFull, ctx);
                    o = chip('O', oFull, oDisp, 'q-o');
                }

                return `<div class="quad">${s}<span class="q-sep">‚Üí</span>${p}<span class="q-sep">‚Üí</span>${o}</div>`;
            }).join('');
        }

        // Format literal with datatype/language
        function formatLiteral(literal) {
            let value = literal.value.replace(/"/g, '\\"');
            let result = `"${value}"`;

            if (literal.language) {
                result += `@${literal.language}`;
            } else if (literal.datatype && literal.datatype.value && literal.datatype.value !== 'http://www.w3.org/2001/XMLSchema#string') {
                result += `^^<${literal.datatype.value}>`;
            }

            return result;
        }

        // Clear playground
        window.clearPlayground = function () {
            document.getElementById('input').value = '';
            document.getElementById('output').textContent = 'Quads will appear here...';
            document.getElementById('mdld-preview').textContent = 'MD-LD preview will appear here...';
            document.getElementById('parse-stats').textContent = '';
            document.getElementById('quadlab-body').innerHTML = '';
            document.getElementById('quadlab-diff').textContent = 'Diff will appear here...';
            document.getElementById('quadlab-stats').textContent = '';
        };

        function normalizeQuadFromFields(s, p, oField) {
            const S = String(s || '').trim();
            const P = String(p || '').trim();
            const O = parseObjectField(oField);
            if (!S || !P || !O) return null;
            return { subject: { termType: 'NamedNode', value: S }, predicate: { termType: 'NamedNode', value: P }, object: O, graph: { termType: 'NamedNode', value: '' } };
        }

        function quadToRow(quad, idx) {
            const tr = document.createElement('tr');
            tr.dataset.idx = String(idx);
            const oField = quad.object.termType === 'Literal' ? formatLiteral(quad.object) : `<${quad.object.value}>`;
            tr.innerHTML = `
                <td><input type="checkbox" data-role="sel" /></td>
                <td><input class="crud-input" data-role="s" value="${escapeHtml(quad.subject.value)}" /></td>
                <td><input class="crud-input" data-role="p" value="${escapeHtml(quad.predicate.value)}" /></td>
                <td><input class="crud-input" data-role="o" value="${escapeHtml(oField)}" /></td>
            `;
            tr.addEventListener('input', () => quadLabUpdateDiff());
            tr.addEventListener('change', () => quadLabUpdateDiff());
            return tr;
        }

        function quadLabGetRows() {
            const rows = [...document.querySelectorAll('#quadlab-body tr')];
            return rows.map(tr => {
                const s = tr.querySelector('[data-role="s"]').value;
                const p = tr.querySelector('[data-role="p"]').value;
                const o = tr.querySelector('[data-role="o"]').value;
                return normalizeQuadFromFields(s, p, o);
            }).filter(Boolean);
        }

        function quadLabDiffFrom(last, next) {
            const lastMap = new Map((last || []).map(q => [quadKey(q), q]));
            const nextMap = new Map((next || []).map(q => [quadKey(q), q]));
            const del = [];
            const add = [];
            for (const [k, q] of lastMap) if (!nextMap.has(k)) del.push(q);
            for (const [k, q] of nextMap) if (!lastMap.has(k)) add.push(q);
            return { delete: del, add };
        }

        window.quadLabReset = function () {
            const body = document.getElementById('quadlab-body');
            body.innerHTML = '';
            const base = lastParse?.result?.quads || [];
            base.forEach((q, i) => body.appendChild(quadToRow(q, i)));
            quadLabUpdateDiff();
        };

        window.quadLabAddRow = function () {
            const body = document.getElementById('quadlab-body');
            const idx = body.children.length;
            const empty = {
                subject: { termType: 'NamedNode', value: 'http://example.org/s' },
                predicate: { termType: 'NamedNode', value: 'http://schema.org/name' },
                object: { termType: 'Literal', value: 'value', language: '', datatype: { termType: 'NamedNode', value: 'http://www.w3.org/2001/XMLSchema#string' } },
                graph: { termType: 'NamedNode', value: '' }
            };
            body.appendChild(quadToRow(empty, idx));
            quadLabUpdateDiff();
        };

        window.quadLabDeleteSelected = function () {
            const body = document.getElementById('quadlab-body');
            [...body.querySelectorAll('tr')].forEach(tr => {
                const sel = tr.querySelector('[data-role="sel"]');
                if (sel?.checked) tr.remove();
            });
            quadLabUpdateDiff();
        };

        function quadLabUpdateDiff() {
            const diffBox = document.getElementById('quadlab-diff');
            const stats = document.getElementById('quadlab-stats');
            const base = lastParse?.result?.quads || [];
            const next = quadLabGetRows();
            const diff = quadLabDiffFrom(base, next);
            const payload = { delete: diff.delete, add: diff.add };
            diffBox.textContent = JSON.stringify(payload, null, 2);
            stats.textContent = `${next.length} quads ‚Ä¢ +${diff.add.length} / -${diff.delete.length}`;
        }

        window.quadLabCopyDiff = async function () {
            const text = document.getElementById('quadlab-diff').textContent || '';
            try {
                await navigator.clipboard.writeText(text);
            } catch {
                // ignore
            }
        };

        window.quadLabApplyDiff = function () {
            if (!lastParse?.result?.origin) return;
            const inputEl = document.getElementById('input');
            const base = lastParse.result.quads || [];
            const next = quadLabGetRows();
            const diff = quadLabDiffFrom(base, next);

            const patched = serialize({
                text: inputEl.value,
                diff,
                origin: lastParse.result.origin,
                options: { context: lastParse.result.context }
            });

            inputEl.value = patched.text;
            parseMDLD();
        };

        window.toggleQuadLab = function () {
            const el = document.getElementById('quadlab');
            if (!el) return;
            el.classList.toggle('hidden');
        };

        // Run all tests
        window.runAllTests = async function () {
            const startTime = performance.now();
            currentTestResults = [];

            const progress = document.getElementById('test-progress');
            const progressBar = document.getElementById('test-progress-bar');
            const stats = document.getElementById('test-stats');
            const testList = document.getElementById('test-list');
            const status = document.getElementById('test-status');

            progress.style.display = 'block';
            stats.style.display = 'grid';
            testList.innerHTML = '';
            status.textContent = 'Running tests...';

            let passed = 0;
            let failed = 0;

            for (let i = 0; i < tests.length; i++) {
                const test = tests[i];
                const testStart = performance.now();

                try {
                    const result = test.fn();
                    const duration = Math.round(performance.now() - testStart);

                    currentTestResults.push({
                        name: test.name,
                        status: 'passed',
                        duration,
                        result
                    });

                    passed++;
                    addTestItem(test.name, 'passed', duration, result);
                } catch (error) {
                    const duration = Math.round(performance.now() - testStart);

                    currentTestResults.push({
                        name: test.name,
                        status: 'failed',
                        duration,
                        error: error.message
                    });

                    failed++;
                    addTestItem(test.name, 'failed', duration, null, error.message);
                }

                const progressPercent = ((i + 1) / tests.length) * 100;
                progressBar.style.width = `${progressPercent}%`;

                document.getElementById('passed-count').textContent = passed;
                document.getElementById('failed-count').textContent = failed;
                document.getElementById('total-count').textContent = tests.length;

                await new Promise(resolve => setTimeout(resolve, 5));
            }

            const totalDuration = Math.round(performance.now() - startTime);
            document.getElementById('duration').textContent = `${totalDuration}ms`;

            setTimeout(() => {
                progress.style.display = 'none';
                status.textContent = `Completed: ${passed} passed, ${failed} failed`;
            }, 500);
        };

        // Add test item to UI
        function addTestItem(name, status, duration, result, error = null) {
            const testList = document.getElementById('test-list');
            const item = document.createElement('div');
            item.className = `test-item ${status}`;

            const icon = status === 'passed' ? '‚úÖ' : '‚ùå';

            item.innerHTML = `
        <div class="test-header">
          <span class="test-icon">${icon}</span>
          <span class="test-name">${name}</span>
          <span class="test-duration">${duration}ms</span>
        </div>
        <div class="test-details" id="details-${name.replace(/\s+/g, '-')}">
          ${result ? `
            <div class="test-input">${result.input}</div>
            <div class="test-output">${(result.output.quads || []).map(q => `${q.subject.value} -> ${q.predicate.value} -> ${q.object.termType === 'Literal' ? formatLiteral(q.object) : `<${q.object.value}>`}`).join('\n')}</div>
          ` : ''}
          ${error ? `<div style="color: #ef4444; font-family: monospace; font-size: 11px;">${error}</div>` : ''}
        </div>
      `;

            item.addEventListener('click', () => {
                const details = item.querySelector('.test-details');
                details.classList.toggle('open');
            });

            testList.appendChild(item);
        }

        // Clear tests
        window.clearTests = function () {
            currentTestResults = [];
            document.getElementById('test-list').innerHTML = '<p style="text-align: center; color: #9ca3af; padding: 1rem;">Click "Run Tests" to see results</p>';
            document.getElementById('test-stats').style.display = 'none';
            document.getElementById('test-progress').style.display = 'none';
            document.getElementById('test-status').textContent = '';
        };

        // Auto-parse on input change
        document.getElementById('input').addEventListener('input', () => {
            clearTimeout(window.parseTimeout);
            window.parseTimeout = setTimeout(parseMDLD, 300);
        });

        // Auto-run tests on page load
        window.addEventListener('load', () => {
            setTimeout(() => {
                runAllTests();
            }, 500);
        });

        // Load initial example
        loadExample('journal');
    </script>
</body>

</html>